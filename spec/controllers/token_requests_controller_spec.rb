require File.expand_path(File.join(File.dirname(__FILE__), '..', 'spec_helper'))

describe TokenRequestsController do
  include Devise::TestHelpers

  describe 'routing' do
    describe '/tokens/:token_id/token_requests' do
      it 'maps POST to the create action' do
        {:post => '/tokens/1/token_requests'}.should \
          route_to(:controller => 'token_requests', :action => 'create',
                   :token_id => '1')
      end

      it 'is generated by token_requests_path' do
        token_requests_path(1).should == '/tokens/1/token_requests'
      end
    end
  end

  context 'with anonymous user' do
    describe '#create' do
      it 'requires an authenticated user' do
        post :create, :token_id => '1'
        response.should redirect_to(new_user_session_path)
      end
    end
  end

  context 'with authenticated user' do
    before(:each) do
      s_user = stub('User')
      request.env['warden'] = stub('Warden', :authenticate => s_user, :authenticate! => s_user)
    end

    describe '#create' do
      context 'with invalid data' do
        before(:each) do
          Token.stub!(:find)
          @token_request = mock_model('TokenRequest').as_new_record
          exception = ActiveRecord::RecordInvalid.new(@token_request)
          TokenRequest.stub!(:create!).and_raise(exception)
        end

        it 'renders the tokens/show template' do
          post :create, :token_id => '1'
          response.should render_template('tokens/show')
        end

        it 'assigns the specified token to the template' do
          Token.should_receive(:find).with('1').and_return(:the_token)
          post :create, :token_id => '1'
          assigns(:token).should == :the_token
        end

        it 'assigns the invalid token request to the template' do
          post :create, :token_id => '1'
          assigns(:new_token_request).should === @token_request
        end
      end
    end
  end
end
